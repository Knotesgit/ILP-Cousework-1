<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeliveryPlanHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">IlpTutorial1</a> &gt; <a href="index.source.html" class="el_package">uk.ac.ed.acp.cw2.utility</a> &gt; <span class="el_source">DeliveryPlanHelper.java</span></div><h1>DeliveryPlanHelper.java</h1><pre class="source lang-java linenums">package uk.ac.ed.acp.cw2.utility;

import uk.ac.ed.acp.cw2.data.*;
import uk.ac.ed.acp.cw2.data.DroneForServicePoint;
import uk.ac.ed.acp.cw2.data.response.*;

import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

// Helper utilities used by the delivery planning logic.
<span class="nc" id="L12">public class DeliveryPlanHelper {</span>

    // Check whether a list of MedDispatchRec valid or not
    public static boolean isValidDispatchList(List&lt;MedDispatchRec&gt; recs) {
<span class="nc bnc" id="L16" title="All 4 branches missed.">        if (recs == null || recs.isEmpty()) return false;</span>
<span class="nc bnc" id="L17" title="All 2 branches missed.">        for (MedDispatchRec rec : recs) {</span>
<span class="nc bnc" id="L18" title="All 2 branches missed.">            if (rec == null) return false;</span>
<span class="nc bnc" id="L19" title="All 2 branches missed.">            if (rec.getId() == null) return false;</span>
<span class="nc bnc" id="L20" title="All 2 branches missed.">            if (rec.getRequirements() == null) return false;</span>
<span class="nc bnc" id="L21" title="All 2 branches missed.">            if (rec.getDelivery() == null) return false;</span>
<span class="nc bnc" id="L22" title="All 4 branches missed.">            if (rec.getDate() == null &amp;&amp; rec.getTime() != null) return false;</span>
<span class="nc" id="L23">            var req = rec.getRequirements();</span>
<span class="nc bnc" id="L24" title="All 4 branches missed.">            if (req.isCooling() &amp;&amp; req.isHeating()) return false;</span>
<span class="nc bnc" id="L25" title="All 2 branches missed.">            if (req.getCapacity() == null) return false;</span>
<span class="nc" id="L26">        }</span>
<span class="nc" id="L27">        return true;</span>
    }

    // Create an empty CalcDeliveryPathResponse with no drone paths and zero cost/moves.
    public static CalcDeliveryPathResponse emptyDeliveryResponse() {
<span class="nc" id="L32">        CalcDeliveryPathResponse response = new CalcDeliveryPathResponse();</span>
<span class="nc" id="L33">        response.setDronePaths(new ArrayList&lt;&gt;());  // empty list</span>
<span class="nc" id="L34">        response.setTotalCost(0.0);</span>
<span class="nc" id="L35">        response.setTotalMoves(0);</span>
<span class="nc" id="L36">        return response;</span>
    }

    // Aggregate a list of finished flights into a CalcDeliveryPathResponse
    public static CalcDeliveryPathResponse buildDeliveryResponse(List&lt;FlightBuilder&gt; finishedFlights) {
<span class="nc" id="L41">        CalcDeliveryPathResponse response = new CalcDeliveryPathResponse();</span>
<span class="nc" id="L42">        double totalCost = 0.0;</span>
<span class="nc" id="L43">        int totalMoves = 0;</span>
<span class="nc" id="L44">        List&lt;CalcDeliveryPathResponse.DronePath&gt; dronePathsList = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L46" title="All 4 branches missed.">        if (finishedFlights == null || finishedFlights.isEmpty()) {</span>
<span class="nc" id="L47">            return emptyDeliveryResponse();</span>
        }

<span class="nc bnc" id="L50" title="All 2 branches missed.">        for (FlightBuilder fb : finishedFlights) {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            if (fb == null) continue;</span>

<span class="nc" id="L53">            double cpm = fb.getCostPerMove();</span>
<span class="nc" id="L54">            double ci  = fb.getCostInitial();</span>
<span class="nc" id="L55">            double cf  = fb.getCostFinal();</span>
<span class="nc" id="L56">            double flightCost = ci + cf + fb.getStepsUsed() * cpm;</span>

<span class="nc" id="L58">            totalCost += flightCost;</span>
<span class="nc" id="L59">            totalMoves += fb.getStepsUsed();</span>

<span class="nc" id="L61">            CalcDeliveryPathResponse.DronePath dp = new CalcDeliveryPathResponse.DronePath();</span>
<span class="nc" id="L62">            dp.setDroneId(fb.getDroneId());</span>

<span class="nc" id="L64">            List&lt;CalcDeliveryPathResponse.DeliverySegment&gt; deliveriesList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (fb.getSegments() != null) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                for (var seg : fb.getSegments()) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                    if (seg == null) continue;</span>
<span class="nc" id="L68">                    CalcDeliveryPathResponse.DeliverySegment out = new CalcDeliveryPathResponse.DeliverySegment();</span>
<span class="nc" id="L69">                    out.setDeliveryId(seg.getDeliveryId());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                    out.setFlightPath(seg.getFlightPath() == null</span>
<span class="nc" id="L71">                            ? new ArrayList&lt;&gt;()</span>
<span class="nc" id="L72">                            : new ArrayList&lt;&gt;(seg.getFlightPath()));</span>
<span class="nc" id="L73">                    deliveriesList.add(out);</span>
<span class="nc" id="L74">                }</span>
            }

<span class="nc" id="L77">            dp.setDeliveries(deliveriesList);</span>
<span class="nc" id="L78">            dronePathsList.add(dp);</span>
<span class="nc" id="L79">        }</span>

<span class="nc" id="L81">        response.setTotalCost(totalCost);</span>
<span class="nc" id="L82">        response.setTotalMoves(totalMoves);</span>
<span class="nc" id="L83">        response.setDronePaths(dronePathsList);</span>
<span class="nc" id="L84">        return response;</span>
    }

    // Build a GeoJSON FeatureCollection from CalcDeliveryPathResponse.
    public static GeoJsonResponseCollection buildGeoJsonResponseCollection(
            CalcDeliveryPathResponse resp) {

<span class="nc" id="L91">        GeoJsonResponseCollection collection = new GeoJsonResponseCollection();</span>
<span class="nc" id="L92">        List&lt;GeoJsonResponse&gt; features = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L94" title="All 6 branches missed.">        if (resp == null || resp.getDronePaths() == null || resp.getDronePaths().isEmpty()) {</span>
<span class="nc" id="L95">            collection.setFeatures(List.of());</span>
<span class="nc" id="L96">            return collection;</span>
        }

<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (CalcDeliveryPathResponse.DronePath dp : resp.getDronePaths()) {</span>
<span class="nc bnc" id="L100" title="All 6 branches missed.">            if (dp == null || dp.getDeliveries() == null || dp.getDeliveries().isEmpty())</span>
<span class="nc" id="L101">                continue;</span>

<span class="nc" id="L103">            List&lt;Coordinate&gt; merged = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L104">            Coordinate lastPrevCoord = null;</span>

            // Merge all segments from this drone
<span class="nc bnc" id="L107" title="All 2 branches missed.">            for (CalcDeliveryPathResponse.DeliverySegment seg : dp.getDeliveries()) {</span>
<span class="nc bnc" id="L108" title="All 6 branches missed.">                if (seg == null || seg.getFlightPath() == null || seg.getFlightPath().isEmpty())</span>
<span class="nc" id="L109">                    continue;</span>

<span class="nc" id="L111">                List&lt;Coordinate&gt; raw = seg.getFlightPath();</span>
                List&lt;Coordinate&gt; cleaned;

                // Cross-segment dedupe: remove the first coordinate iff equal to previous segmentâ€™s last
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (lastPrevCoord != null) {</span>
<span class="nc" id="L116">                    Coordinate first = raw.get(0);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (first.getLat() == lastPrevCoord.getLat() &amp;&amp;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                            first.getLng() == lastPrevCoord.getLng()) {</span>
<span class="nc" id="L119">                        cleaned = raw.subList(1, raw.size());</span>
                    } else {
<span class="nc" id="L121">                        cleaned = raw;</span>
                    }
<span class="nc" id="L123">                } else {</span>
<span class="nc" id="L124">                    cleaned = raw;</span>
                }

<span class="nc" id="L127">                merged.addAll(cleaned);</span>

                // Store end of this segment as candidate for dedupe
<span class="nc" id="L130">                lastPrevCoord = raw.get(raw.size() - 1);</span>
<span class="nc" id="L131">            }</span>

            // Convert to [[lng, lat]] list
<span class="nc" id="L134">            List&lt;List&lt;Double&gt;&gt; coords = toLngLat(merged);</span>

            // Build Feature for this drone
<span class="nc" id="L137">            GeoJsonResponse feature = new GeoJsonResponse();</span>

<span class="nc" id="L139">            GeoJsonResponse.Properties props = new GeoJsonResponse.Properties();</span>
<span class="nc" id="L140">            props.setDroneId(dp.getDroneId());</span>
<span class="nc" id="L141">            feature.setProperties(props);</span>

<span class="nc" id="L143">            GeoJsonResponse.Geometry geom = new GeoJsonResponse.Geometry();</span>
<span class="nc" id="L144">            geom.setCoordinates(coords);</span>
<span class="nc" id="L145">            feature.setGeometry(geom);</span>

<span class="nc" id="L147">            features.add(feature);</span>
<span class="nc" id="L148">        }</span>

<span class="nc" id="L150">        collection.setFeatures(features);</span>
<span class="nc" id="L151">        return collection;</span>
    }




    // Extract all polygon vertex lists from the given restricted areas.
    public static List&lt;List&lt;Coordinate&gt;&gt; extractPolygons(List&lt;RestrictedArea&gt; areas) {
<span class="fc" id="L159">        List&lt;List&lt;Coordinate&gt;&gt; polygons = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (areas == null) return polygons;</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        for (RestrictedArea area : areas) {</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">            if (area == null) continue;</span>
<span class="fc" id="L163">            List&lt;Coordinate&gt; vertices = area.getVertices();</span>
<span class="pc bpc" id="L164" title="2 of 4 branches missed.">            if (vertices != null &amp;&amp; !vertices.isEmpty()) {</span>
                // Add the polygon (list of vertices) to the result
<span class="fc" id="L166">                polygons.add(new ArrayList&lt;&gt;(vertices));</span>
            }
<span class="fc" id="L168">        }</span>
<span class="fc" id="L169">        return polygons;</span>
    }

    // Compute bounding boxes (min/max lng/lat) for each restricted area polygon.
    public static List&lt;BoundBox&gt; extractBBoxes(List&lt;RestrictedArea&gt; areas) {
<span class="fc" id="L174">        List&lt;BoundBox&gt; boxes = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (areas == null) return boxes;</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        for (RestrictedArea area : areas) {</span>
<span class="fc" id="L177">            BoundBox BBox = polyBox(area.getVertices());</span>
<span class="fc" id="L178">            boxes.add(BBox);</span>
<span class="fc" id="L179">        }</span>
<span class="fc" id="L180">        return boxes;</span>
    }

    // Find the DroneForServicePoint.Item entry for a given drone ID in a service point.
    public static DroneForServicePoint.Item findDroneItem(DroneForServicePoint dfsp, String droneId) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (dfsp == null) return null;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        for (DroneForServicePoint.Item item : dfsp.getDrones()) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (Objects.equals(item.getId(), droneId)) return item;</span>
<span class="nc" id="L188">        }</span>
<span class="nc" id="L189">        return null;</span>
    }

    // Check that a per-delivery cost does not exceed any of the provided maxCost constraints.
    // Comparison uses a tolerance eps
    public static boolean withinAllMaxCosts(double perDeliveryCost, List&lt;Double&gt; existingMaxCost, double eps) {
<span class="nc bnc" id="L195" title="All 4 branches missed.">        if (existingMaxCost == null || existingMaxCost.isEmpty()) return true;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        for (Double cost : existingMaxCost) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (cost == null) continue;</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (perDeliveryCost - cost &gt; eps) return false;</span>
<span class="nc" id="L199">        }</span>
<span class="nc" id="L200">        return true;</span>
    }

    // Construct a bound box for a region
    private static BoundBox polyBox(List&lt;Coordinate&gt; rectClosed) {
<span class="fc" id="L205">        double minLng = Double.POSITIVE_INFINITY, minLat = Double.POSITIVE_INFINITY;</span>
<span class="fc" id="L206">        double maxLng = Double.NEGATIVE_INFINITY, maxLat = Double.NEGATIVE_INFINITY;</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">        for (var c : rectClosed) {</span>
<span class="fc" id="L208">            minLng = Math.min(minLng, c.getLng());</span>
<span class="fc" id="L209">            maxLng = Math.max(maxLng, c.getLng());</span>
<span class="fc" id="L210">            minLat = Math.min(minLat, c.getLat());</span>
<span class="fc" id="L211">            maxLat = Math.max(maxLat, c.getLat());</span>
<span class="fc" id="L212">        }</span>
<span class="fc" id="L213">        return new BoundBox(new Coordinate(maxLng, maxLat), new Coordinate(minLng, minLat));</span>
    }

    // Convert Coordinate to List of pairs of Lng lat
    private static List&lt;List&lt;Double&gt;&gt; toLngLat(List&lt;Coordinate&gt; line) {
<span class="nc" id="L218">        List&lt;List&lt;Double&gt;&gt; out = new ArrayList&lt;&gt;(line.size());</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        for (Coordinate c : line) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (c != null) out.add(List.of(c.getLng(), c.getLat()));</span>
<span class="nc" id="L221">        }</span>
<span class="nc" id="L222">        return out;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>